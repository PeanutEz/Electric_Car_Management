<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>üîî Notification Test - Real-time</title>
		<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
					Roboto, 'Helvetica Neue', Arial, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 900px;
				margin: 0 auto;
			}

			.header {
				background: white;
				border-radius: 16px;
				padding: 30px;
				margin-bottom: 20px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
			}

			.header h1 {
				color: #667eea;
				font-size: 32px;
				margin-bottom: 10px;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.status {
				display: inline-block;
				padding: 8px 16px;
				border-radius: 20px;
				font-size: 14px;
				font-weight: 600;
			}

			.status.offline {
				background: #fee;
				color: #c33;
			}

			.status.online {
				background: #efe;
				color: #3c3;
			}

			.card {
				background: white;
				border-radius: 16px;
				padding: 25px;
				margin-bottom: 20px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
			}

			.card h2 {
				color: #333;
				font-size: 20px;
				margin-bottom: 15px;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.badge {
				background: #ff4757;
				color: white;
				font-size: 12px;
				padding: 4px 10px;
				border-radius: 12px;
				font-weight: 600;
			}

			.input-group {
				margin-bottom: 15px;
			}

			.input-group label {
				display: block;
				color: #666;
				font-size: 14px;
				margin-bottom: 5px;
				font-weight: 500;
			}

			.input-group input {
				width: 100%;
				padding: 12px 16px;
				border: 2px solid #e0e0e0;
				border-radius: 8px;
				font-size: 14px;
				transition: border-color 0.3s;
			}

			.input-group input:focus {
				outline: none;
				border-color: #667eea;
			}

			.btn {
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
			}

			.btn-primary {
				background: #667eea;
				color: white;
			}

			.btn-primary:hover {
				background: #5568d3;
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			.btn-secondary {
				background: #f0f0f0;
				color: #333;
			}

			.btn-secondary:hover {
				background: #e0e0e0;
			}

			.notification-list {
				max-height: 500px;
				overflow-y: auto;
			}

			.notification-item {
				background: #f8f9fa;
				border-radius: 12px;
				padding: 16px;
				margin-bottom: 12px;
				border-left: 4px solid #667eea;
				transition: all 0.3s;
				position: relative;
			}

			.notification-item:hover {
				background: #e9ecef;
				transform: translateX(4px);
			}

			.notification-item.unread {
				background: #e7f3ff;
				border-left-color: #2196f3;
			}

			.notification-item.approved {
				border-left-color: #4caf50;
			}

			.notification-item.rejected {
				border-left-color: #f44336;
			}

			.notification-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}

			.notification-title {
				font-size: 16px;
				font-weight: 600;
				color: #333;
			}

			.notification-time {
				font-size: 12px;
				color: #999;
			}

			.notification-message {
				font-size: 14px;
				color: #666;
				line-height: 1.5;
			}

			.notification-actions {
				margin-top: 12px;
				display: flex;
				gap: 8px;
			}

			.btn-small {
				padding: 6px 12px;
				font-size: 12px;
			}

			.empty-state {
				text-align: center;
				padding: 60px 20px;
				color: #999;
			}

			.empty-state svg {
				width: 80px;
				height: 80px;
				opacity: 0.3;
				margin-bottom: 16px;
			}

			.toast {
				position: fixed;
				top: 20px;
				right: 20px;
				background: white;
				border-radius: 12px;
				padding: 20px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
				min-width: 300px;
				animation: slideIn 0.3s ease-out;
				z-index: 1000;
			}

			@keyframes slideIn {
				from {
					transform: translateX(400px);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}

			.toast-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}

			.toast-title {
				font-weight: 600;
				font-size: 16px;
			}

			.toast-close {
				background: none;
				border: none;
				font-size: 20px;
				cursor: pointer;
				color: #999;
			}

			.toast-message {
				font-size: 14px;
				color: #666;
			}

			.loading {
				text-align: center;
				padding: 20px;
				color: #999;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>üîî Real-time Notification System</h1>
				<p style="color: #666; margin-bottom: 15px">
					Test notification khi admin approve/reject post
				</p>
				<span id="connectionStatus" class="status offline"
					>‚ö´ Offline</span
				>
			</div>

			<div class="card">
				<h2>üîê Authentication</h2>
				<div class="input-group">
					<label for="jwtToken">JWT Token:</label>
					<input
						type="text"
						id="jwtToken"
						placeholder="Paste your JWT token here..." />
				</div>
				<button class="btn btn-primary" onclick="connect()">
					üîå Connect
				</button>
				<button class="btn btn-secondary" onclick="disconnect()">
					üîå Disconnect
				</button>
			</div>

			<div class="card">
				<h2>
					üì© Notifications
					<span id="unreadBadge" class="badge" style="display: none"
						>0</span
					>
				</h2>
				<div style="margin-bottom: 15px; display: flex; gap: 10px">
					<button
						class="btn btn-secondary btn-small"
						onclick="loadNotifications()">
						üîÑ Refresh
					</button>
					<button
						class="btn btn-secondary btn-small"
						onclick="markAllAsRead()">
						‚úì Mark All Read
					</button>
				</div>
				<div id="notificationList" class="notification-list">
					<div class="loading">Connecting...</div>
				</div>
			</div>
		</div>

		<script>
			let socket = null;
			let currentUserId = null;

			function connect() {
				const token = document.getElementById('jwtToken').value.trim();
				if (!token) {
					alert('Please enter JWT token!');
					return;
				}

				// Decode JWT ƒë·ªÉ l·∫•y userId
				try {
					const payload = JSON.parse(atob(token.split('.')[1]));
					currentUserId = payload.id; // Token c√≥ field 'id'
					console.log('üë§ User ID:', currentUserId);
				} catch (e) {
					alert('Invalid JWT token format!');
					return;
				}

				socket = io('http://localhost:3000', {
					auth: { token },
				});

				socket.on('connect', () => {
					console.log('‚úÖ Connected:', socket.id);
					document.getElementById('connectionStatus').textContent =
						'‚úÖ Online';
					document.getElementById('connectionStatus').className =
						'status online';

					loadNotifications();
					loadUnreadCount();
				});

				socket.on('connect_error', (error) => {
					console.error('‚ùå Connection error:', error.message);
					document.getElementById('connectionStatus').textContent =
						'‚ùå Connection Failed';
					document.getElementById('connectionStatus').className =
						'status offline';
				});

				socket.on('disconnect', () => {
					console.log('‚ùå Disconnected');
					document.getElementById('connectionStatus').textContent =
						'‚ö´ Offline';
					document.getElementById('connectionStatus').className =
						'status offline';
				});

				// üîî Nh·∫≠n notification m·ªõi real-time
				socket.on('notification:new', (notification) => {
					console.log('üì© New notification:', notification);

					// Show toast
					showToast(notification.title, notification.message);

					// Refresh list
					loadNotifications();
					loadUnreadCount();
				});
			}

			function disconnect() {
				if (socket) {
					socket.disconnect();
					socket = null;
				}
			}

			function loadNotifications() {
				if (!socket || !socket.connected) {
					document.getElementById('notificationList').innerHTML =
						'<div class="loading">Not connected</div>';
					return;
				}

				socket.emit(
					'notification:list',
					{ limit: 20, offset: 0 },
					(response) => {
						if (response.success) {
							renderNotifications(response.notifications);
						} else {
							console.error(
								'Error loading notifications:',
								response.error,
							);
						}
					},
				);
			}

			function loadUnreadCount() {
				if (!socket || !socket.connected) return;

				socket.emit('notification:unread', (response) => {
					if (response.success) {
						const badge = document.getElementById('unreadBadge');
						if (response.count > 0) {
							badge.textContent = response.count;
							badge.style.display = 'inline-block';
						} else {
							badge.style.display = 'none';
						}
					}
				});
			}

			function renderNotifications(notifications) {
				const container = document.getElementById('notificationList');

				if (notifications.length === 0) {
					container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <p>Ch∆∞a c√≥ notification n√†o</p>
                    </div>
                `;
					return;
				}

				container.innerHTML = notifications
					.map((notif) => {
						const isUnread = notif.is_read === 0;
						const isApproved = notif.type === 'post_approved';
						const isRejected = notif.type === 'post_rejected';
						const time = new Date(notif.created_at).toLocaleString(
							'vi-VN',
						);

						let classes = 'notification-item';
						if (isUnread) classes += ' unread';
						if (isApproved) classes += ' approved';
						if (isRejected) classes += ' rejected';

						return `
                    <div class="${classes}">
                        <div class="notification-header">
                            <span class="notification-title">${
								notif.title
							}</span>
                            <span class="notification-time">${time}</span>
                        </div>
                        <div class="notification-message">${notif.message}</div>
                        <div class="notification-actions">
                            ${
								isUnread
									? `<button class="btn btn-secondary btn-small" onclick="markAsRead(${notif.id})">‚úì Mark Read</button>`
									: ''
							}
                            <button class="btn btn-secondary btn-small" onclick="deleteNotification(${
								notif.id
							})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
					})
					.join('');
			}

			function markAsRead(notificationId) {
				if (!socket) return;

				socket.emit(
					'notification:read',
					{ notificationId },
					(response) => {
						if (response.success) {
							loadNotifications();
							loadUnreadCount();
						}
					},
				);
			}

			function markAllAsRead() {
				if (!socket) return;

				socket.emit('notification:readAll', (response) => {
					if (response.success) {
						loadNotifications();
						loadUnreadCount();
					}
				});
			}

			function deleteNotification(notificationId) {
				if (!socket) return;

				socket.emit(
					'notification:delete',
					{ notificationId },
					(response) => {
						if (response.success) {
							loadNotifications();
							loadUnreadCount();
						}
					},
				);
			}

			function showToast(title, message) {
				const toast = document.createElement('div');
				toast.className = 'toast';
				toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-title">${title}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
                <div class="toast-message">${message}</div>
            `;

				document.body.appendChild(toast);

				setTimeout(() => {
					toast.remove();
				}, 5000);
			}
		</script>
	</body>
</html>
