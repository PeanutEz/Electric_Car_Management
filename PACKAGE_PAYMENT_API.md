# Package Payment API Documentation

## üì¶ API: Package Payment v·ªõi Credit Check

**Endpoint:** `POST /api/payment/package-payment`

**M√¥ t·∫£:** API n√†y x·ª≠ l√Ω thanh to√°n package/g√≥i d·ªãch v·ª•. H·ªá th·ªëng s·∫Ω ki·ªÉm tra `total_credit` c·ªßa user:
- ‚úÖ **N·∫øu ƒë·ªß ti·ªÅn:** Tr·ª´ credit ‚Üí C·ªông quota ‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ th√†nh c√¥ng
- ‚ùå **N·∫øu kh√¥ng ƒë·ªß:** T·∫°o link PayOS ‚Üí Tr·∫£ v·ªÅ checkout URL

---

## üîë Request

### Headers
```
Content-Type: application/json
```

### Body Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `user_id` | number | ‚úÖ Yes | ID c·ªßa user c·∫ßn thanh to√°n |
| `service_id` | number | ‚úÖ Yes | ID c·ªßa service/package (t·ª´ b·∫£ng `services`) |

### Request Example
```json
{
  "user_id": 1,
  "service_id": 7
}
```

---

## üì§ Response

### Case 1: ‚úÖ ƒê·ªß Credit - Thanh to√°n th√†nh c√¥ng

**HTTP Status:** `200 OK`

```json
{
  "success": true,
  "message": "Thanh to√°n th√†nh c√¥ng! ƒê√£ tr·ª´ 100000 VND t·ª´ t√†i kho·∫£n. B·∫°n nh·∫≠n ƒë∆∞·ª£c 3 l∆∞·ª£t ƒëƒÉng b√†i.",
  "data": {
    "remainingCredit": 50000,
    "quotaAdded": 3
  }
}
```

**Gi·∫£i th√≠ch:**
- `remainingCredit`: S·ªë credit c√≤n l·∫°i sau khi tr·ª´
- `quotaAdded`: S·ªë l∆∞·ª£ng quota ƒë∆∞·ª£c c·ªông (t·ª´ `number_of_post` trong b·∫£ng `services`)

---

### Case 2: ‚ùå Kh√¥ng ƒë·ªß Credit - C·∫ßn thanh to√°n PayOS

**HTTP Status:** `200 OK`

```json
{
  "success": false,
  "needPayment": true,
  "message": "S·ªë d∆∞ kh√¥ng ƒë·ªß (20000 VND). C·∫ßn thanh to√°n 100000 VND.",
  "data": {
    "checkoutUrl": "https://pay.payos.vn/web/d7a3e96afcc8477fb22a7ec0bc43c8ba",
    "orderCode": 456789,
    "remainingCredit": 20000
  }
}
```

**Gi·∫£i th√≠ch:**
- `checkoutUrl`: Link PayOS ƒë·ªÉ user thanh to√°n
- `orderCode`: M√£ order ƒë√£ ƒë∆∞·ª£c t·∫°o trong database v·ªõi status `PENDING`
- `remainingCredit`: S·ªë credit hi·ªán t·∫°i c·ªßa user

---

### Case 3: ‚ö†Ô∏è L·ªói Validation

**HTTP Status:** `400 Bad Request`

```json
{
  "success": false,
  "message": "Missing required fields: user_id, service_id"
}
```

ho·∫∑c

```json
{
  "success": false,
  "message": "user_id and service_id must be numbers"
}
```

ho·∫∑c

```json
{
  "success": false,
  "message": "D·ªãch v·ª• kh√¥ng t·ªìn t·∫°i"
}
```

---

### Case 4: ‚ùå Server Error

**HTTP Status:** `500 Internal Server Error`

```json
{
  "success": false,
  "message": "X·ª≠ l√Ω thanh to√°n package th·∫•t b·∫°i"
}
```

---

## üîÑ Business Logic Flow

```mermaid
graph TD
    A[POST /api/payment/package-payment] --> B{Validate Input}
    B -->|Invalid| C[Return 400 Error]
    B -->|Valid| D[Get Service Info]
    D --> E[Get User Credit]
    E --> F{Credit >= Service Cost?}
    
    F -->|Yes - ƒê·ªß ti·ªÅn| G[Begin Transaction]
    G --> H[Tr·ª´ total_credit]
    H --> I[Parse service_ref]
    I --> J[C·ªông quota cho c√°c service]
    J --> K[T·∫°o order PAID]
    K --> L[Log transaction]
    L --> M[Commit Transaction]
    M --> N[Return Success + Remaining Credit]
    
    F -->|No - Kh√¥ng ƒë·ªß| O[Rollback Transaction]
    O --> P[T·∫°o order PENDING]
    P --> Q{Create PayOS Link}
    Q -->|Success| R[Return Checkout URL]
    Q -->|Failed| S[Return Error]
```

---

## üíæ Database Changes

### Khi ƒë·ªß credit (Case 1):

1. **Table `users`:**
   ```sql
   UPDATE users 
   SET total_credit = total_credit - service_cost 
   WHERE id = user_id;
   ```

2. **Table `user_quota`:**
   ```sql
   -- Cho m·ªói service_id trong service_ref (e.g., "1,3")
   UPDATE user_quota 
   SET amount = amount + number_of_post 
   WHERE user_id = ? AND service_id = ?;
   
   -- Ho·∫∑c INSERT n·∫øu ch∆∞a c√≥
   INSERT INTO user_quota (user_id, service_id, amount) 
   VALUES (?, ?, number_of_post);
   ```

3. **Table `orders`:**
   ```sql
   INSERT INTO orders 
   (code, type, service_id, buyer_id, price, status, payment_method, created_at) 
   VALUES (orderCode, 'package', serviceId, userId, cost, 'PAID', 'CREDIT', NOW());
   ```

4. **Table `transaction_detail`:**
   ```sql
   INSERT INTO transaction_detail 
   (order_id, user_id, unit, type, credits) 
   VALUES (orderId, userId, 'CREDIT', 'Decrease', cost);
   ```

### Khi kh√¥ng ƒë·ªß credit (Case 2):

1. **Table `orders`:**
   ```sql
   INSERT INTO orders 
   (code, type, service_id, buyer_id, price, status, payment_method, created_at) 
   VALUES (orderCode, 'package', serviceId, userId, cost, 'PENDING', 'PAYOS', NOW());
   ```

2. **PayOS API:** T·∫°o payment link v·ªõi `orderCode`

---

## üìä Example Services Data

T·ª´ b·∫£ng `services`:

| ID | Name | Type | Cost | number_of_post | service_ref | product_type |
|----|------|------|------|----------------|-------------|--------------|
| 7 | G√≥i Pro | package | 100000 | 3 | 1,3 | vehicle |
| 8 | G√≥i Enterprise | package | 300000 | 5 | 1,3 | vehicle |
| 9 | G√≥i Pro | package | 100000 | 3 | 2,4 | battery |
| 10 | G√≥i Enterprise | package | 300000 | 5 | 2,4 | battery |

**`service_ref` gi·∫£i th√≠ch:**
- `"1,3"` = Service ID 1 (ƒêƒÉng post vehicle) + Service ID 3 (ƒê·∫©y post vehicle)
- `"2,4"` = Service ID 2 (ƒêƒÉng post battery) + Service ID 4 (ƒê·∫©y post battery)

Khi mua package, quota s·∫Ω ƒë∆∞·ª£c c·ªông cho **T·∫§T C·∫¢** c√°c service trong `service_ref`.

---

## üß™ Testing Examples

### Test 1: User c√≥ ƒë·ªß credit

**Setup:**
```sql
-- User c√≥ 150,000 VND credit
UPDATE users SET total_credit = 150000 WHERE id = 1;

-- Package Pro cost 100,000 VND, cho 3 quota
SELECT * FROM services WHERE id = 7;
```

**Request:**
```bash
curl -X POST http://localhost:3000/api/payment/package-payment \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 1,
    "service_id": 7
  }'
```

**Expected Response:**
```json
{
  "success": true,
  "message": "Thanh to√°n th√†nh c√¥ng! ƒê√£ tr·ª´ 100000 VND t·ª´ t√†i kho·∫£n. B·∫°n nh·∫≠n ƒë∆∞·ª£c 3 l∆∞·ª£t ƒëƒÉng b√†i.",
  "data": {
    "remainingCredit": 50000,
    "quotaAdded": 3
  }
}
```

**Verify:**
```sql
-- Check user credit
SELECT total_credit FROM users WHERE id = 1; -- Should be 50000

-- Check quota
SELECT * FROM user_quota WHERE user_id = 1 AND service_id IN (1, 3);
-- Both should have amount = 3

-- Check order
SELECT * FROM orders WHERE buyer_id = 1 ORDER BY created_at DESC LIMIT 1;
-- status should be 'PAID', payment_method 'CREDIT'
```

---

### Test 2: User kh√¥ng ƒë·ªß credit

**Setup:**
```sql
-- User ch·ªâ c√≥ 50,000 VND credit
UPDATE users SET total_credit = 50000 WHERE id = 1;
```

**Request:**
```bash
curl -X POST http://localhost:3000/api/payment/package-payment \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 1,
    "service_id": 7
  }'
```

**Expected Response:**
```json
{
  "success": false,
  "needPayment": true,
  "message": "S·ªë d∆∞ kh√¥ng ƒë·ªß (50000 VND). C·∫ßn thanh to√°n 100000 VND.",
  "data": {
    "checkoutUrl": "https://pay.payos.vn/web/...",
    "orderCode": 123456,
    "remainingCredit": 50000
  }
}
```

**Verify:**
```sql
-- Check order created with PENDING status
SELECT * FROM orders WHERE buyer_id = 1 ORDER BY created_at DESC LIMIT 1;
-- status should be 'PENDING', payment_method 'PAYOS'

-- Credit should NOT be deducted
SELECT total_credit FROM users WHERE id = 1; -- Still 50000
```

---

## üîó Integration with Frontend

### React/Vue Example:

```typescript
async function purchasePackage(userId: number, serviceId: number) {
  try {
    const response = await fetch('/api/payment/package-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: userId,
        service_id: serviceId,
      }),
    });

    const result = await response.json();

    if (result.success) {
      // ‚úÖ Thanh to√°n th√†nh c√¥ng b·∫±ng credit
      alert(result.message);
      console.log('Remaining credit:', result.data.remainingCredit);
      console.log('Quota added:', result.data.quotaAdded);
      // Refresh user profile or quota display
    } else if (result.needPayment) {
      // ‚ùå C·∫ßn thanh to√°n qua PayOS
      alert(result.message);
      // Redirect to PayOS checkout
      window.location.href = result.data.checkoutUrl;
    } else {
      // ‚ö†Ô∏è Other errors
      alert(result.message);
    }
  } catch (error) {
    console.error('Package payment error:', error);
    alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω thanh to√°n');
  }
}
```

---

## üîê Security Considerations

1. **Authentication:** API n√†y n√™n c√≥ middleware `authenticateToken` ƒë·ªÉ verify user
2. **Authorization:** N√™n check `user_id` trong token c√≥ match v·ªõi `user_id` trong body kh√¥ng
3. **Rate Limiting:** Prevent spam requests
4. **Transaction Safety:** S·ª≠ d·ª•ng database transaction ƒë·ªÉ ƒë·∫£m b·∫£o data consistency

### Recommended Route Update:
```typescript
router.post('/package-payment', authenticateToken, packagePaymentController);
```

### Controller Update ƒë·ªÉ check authorization:
```typescript
export const packagePaymentController = async (req: Request, res: Response) => {
  try {
    const { user_id, service_id } = req.body;
    const tokenUserId = (req as any).user?.id; // From authenticateToken middleware
    
    // Check authorization
    if (tokenUserId !== user_id) {
      return res.status(403).json({
        success: false,
        message: 'Unauthorized: Cannot pay for another user',
      });
    }
    
    // ... rest of the code
  } catch (error: any) {
    // ... error handling
  }
};
```

---

## üìù Notes

1. **Service Ref:** Package s·∫Ω c·ªông quota cho T·∫§T C·∫¢ c√°c service trong `service_ref` (v√≠ d·ª•: "1,3" s·∫Ω c·ªông quota cho service 1 v√† 3)

2. **Transaction Safety:** T·∫•t c·∫£ database operations ƒë·ªÅu ƒë∆∞·ª£c wrap trong transaction ƒë·ªÉ ƒë·∫£m b·∫£o atomicity

3. **PayOS Webhook:** Sau khi user thanh to√°n qua PayOS, webhook s·∫Ω trigger v√† x·ª≠ l√Ω logic c·ªông quota t∆∞∆°ng t·ª±

4. **Order Type:** Orders c√≥ field `type` = 'package' ƒë·ªÉ ph√¢n bi·ªát v·ªõi 'post', 'push', 'verify'

5. **Credit vs PayOS:**
   - Credit: Instant, kh√¥ng qua b√™n th·ª© 3
   - PayOS: User ph·∫£i redirect v√† thanh to√°n, sau ƒë√≥ webhook x·ª≠ l√Ω

---

## üêõ Troubleshooting

### Issue: "D·ªãch v·ª• kh√¥ng t·ªìn t·∫°i"
- **Cause:** `service_id` kh√¥ng t·ªìn t·∫°i trong b·∫£ng `services`
- **Solution:** Check `SELECT * FROM services WHERE id = ?`

### Issue: "User kh√¥ng t·ªìn t·∫°i"
- **Cause:** `user_id` kh√¥ng t·ªìn t·∫°i trong b·∫£ng `users`
- **Solution:** Check `SELECT * FROM users WHERE id = ?`

### Issue: PayOS error khi t·∫°o link
- **Cause:** 
  - Sai API key/checksum key
  - PayOS service down
  - Network error
- **Solution:** 
  - Check `.env` c√≥ ƒë·ªß: `PAYOS_API_KEY`, `PAYOS_CHECKSUM_KEY`, `PAYOS_CLIENT_ID`
  - Check PayOS dashboard status
  - Check console log cho chi ti·∫øt error

### Issue: Quota kh√¥ng ƒë∆∞·ª£c c·ªông
- **Cause:** Transaction rollback do l·ªói ·ªü gi·ªØa ch·ª´ng
- **Solution:** 
  - Check console log
  - Verify `service_ref` format ƒë√∫ng (e.g., "1,3")
  - Check `number_of_post` c√≥ gi√° tr·ªã h·ª£p l·ªá

---

## ‚úÖ Success Checklist

- [ ] API endpoint `/api/payment/package-payment` ho·∫°t ƒë·ªông
- [ ] Validate input (user_id, service_id required v√† ph·∫£i l√† s·ªë)
- [ ] Check user credit ƒë·ªß/kh√¥ng ƒë·ªß ch√≠nh x√°c
- [ ] Tr·ª´ credit v√† c·ªông quota ƒë√∫ng khi ƒë·ªß ti·ªÅn
- [ ] T·∫°o PayOS link ƒë√∫ng khi kh√¥ng ƒë·ªß ti·ªÅn
- [ ] Order ƒë∆∞·ª£c t·∫°o v·ªõi status ƒë√∫ng (PAID/PENDING)
- [ ] Transaction rollback khi c√≥ l·ªói
- [ ] Response format chu·∫©n cho frontend
- [ ] Error handling ƒë·∫ßy ƒë·ªß
- [ ] Swagger documentation

---

## üéØ Future Enhancements

1. **Add Authentication:** `authenticateToken` middleware
2. **Add Authorization:** Check token user_id === body user_id
3. **Add Rate Limiting:** Prevent abuse
4. **Add Email Notification:** G·ª≠i email khi mua package th√†nh c√¥ng
5. **Add Refund Logic:** X·ª≠ l√Ω ho√†n ti·ªÅn n·∫øu c·∫ßn
6. **Add Package History:** API ƒë·ªÉ xem l·ªãch s·ª≠ mua package
7. **Add Quota Expiry:** Package c√≥ th·ªùi h·∫°n s·ª≠ d·ª•ng

---

Ch√∫c b·∫°n tri·ªÉn khai th√†nh c√¥ng! üöÄ
