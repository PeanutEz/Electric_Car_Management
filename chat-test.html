<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Simple Chat Test</title>
		<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.container {
				background: white;
				border-radius: 20px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
				width: 90%;
				max-width: 1200px;
				height: 80vh;
				display: flex;
				overflow: hidden;
			}

			.sidebar {
				width: 300px;
				background: #f8f9fa;
				border-right: 1px solid #e0e0e0;
				display: flex;
				flex-direction: column;
			}

			.sidebar-header {
				padding: 20px;
				background: #667eea;
				color: white;
			}

			.sidebar-header h2 {
				font-size: 20px;
				margin-bottom: 10px;
			}

			.user-info {
				font-size: 12px;
				opacity: 0.9;
			}

			.user-list {
				flex: 1;
				overflow-y: auto;
			}

			.user-item {
				padding: 15px 20px;
				border-bottom: 1px solid #e0e0e0;
				cursor: pointer;
				transition: background 0.2s;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.user-item:hover {
				background: #e9ecef;
			}

			.user-item.active {
				background: #e7eaff;
				border-left: 3px solid #667eea;
			}

			.user-avatar {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background: #667eea;
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
			}

			.user-details {
				flex: 1;
			}

			.user-name {
				font-weight: 600;
				margin-bottom: 4px;
			}

			.user-last-message {
				font-size: 12px;
				color: #666;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.online-indicator {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				background: #28a745;
			}

			.unread-badge {
				background: #dc3545;
				color: white;
				padding: 2px 8px;
				border-radius: 10px;
				font-size: 11px;
				font-weight: bold;
			}

			.chat-area {
				flex: 1;
				display: flex;
				flex-direction: column;
			}

			.chat-header {
				padding: 20px;
				background: white;
				border-bottom: 1px solid #e0e0e0;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.chat-header h3 {
				flex: 1;
			}

			.typing-indicator {
				font-size: 12px;
				color: #666;
				font-style: italic;
			}

			.messages {
				flex: 1;
				overflow-y: auto;
				padding: 20px;
				background: #f8f9fa;
			}

			.message {
				margin-bottom: 15px;
				display: flex;
				gap: 10px;
			}

			.message.own {
				flex-direction: row-reverse;
			}

			.message-avatar {
				width: 35px;
				height: 35px;
				border-radius: 50%;
				background: #667eea;
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 14px;
				font-weight: bold;
				flex-shrink: 0;
			}

			.message-content {
				max-width: 60%;
			}

			.message-bubble {
				padding: 10px 15px;
				border-radius: 15px;
				background: white;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			}

			.message.own .message-bubble {
				background: #667eea;
				color: white;
			}

			.message-time {
				font-size: 11px;
				color: #999;
				margin-top: 5px;
			}

			.message-input-area {
				padding: 20px;
				background: white;
				border-top: 1px solid #e0e0e0;
				display: flex;
				gap: 10px;
			}

			.message-input {
				flex: 1;
				padding: 12px 15px;
				border: 1px solid #e0e0e0;
				border-radius: 25px;
				outline: none;
				font-size: 14px;
			}

			.message-input:focus {
				border-color: #667eea;
			}

			.send-button {
				padding: 12px 25px;
				background: #667eea;
				color: white;
				border: none;
				border-radius: 25px;
				cursor: pointer;
				font-weight: 600;
				transition: background 0.2s;
			}

			.send-button:hover {
				background: #5568d3;
			}

			.login-screen {
				background: white;
				padding: 40px;
				border-radius: 20px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
				text-align: center;
				max-width: 400px;
			}

			.login-screen h2 {
				margin-bottom: 30px;
				color: #667eea;
			}

			.login-input {
				width: 100%;
				padding: 12px 15px;
				margin-bottom: 15px;
				border: 1px solid #e0e0e0;
				border-radius: 10px;
				outline: none;
			}

			.login-input:focus {
				border-color: #667eea;
			}

			.login-button {
				width: 100%;
				padding: 12px;
				background: #667eea;
				color: white;
				border: none;
				border-radius: 10px;
				cursor: pointer;
				font-weight: 600;
				font-size: 16px;
			}

			.status-indicator {
				padding: 10px;
				text-align: center;
				font-size: 12px;
				background: #d4edda;
				color: #155724;
			}

			.status-indicator.disconnected {
				background: #f8d7da;
				color: #721c24;
			}
		</style>
	</head>
	<body>
		<div id="loginScreen" class="login-screen">
			<h2>üí¨ Simple Chat</h2>
			<input
				type="text"
				id="tokenInput"
				class="login-input"
				placeholder="Nh·∫≠p JWT Token" />
			<button onclick="connect()" class="login-button">K·∫øt n·ªëi</button>
			<p style="margin-top: 20px; font-size: 12px; color: #666">
				ƒêƒÉng nh·∫≠p ƒë·ªÉ l·∫•y token, sau ƒë√≥ paste v√†o ƒë√¢y
			</p>
		</div>

		<div id="chatContainer" class="container" style="display: none">
			<div class="sidebar">
				<div class="sidebar-header">
					<h2>üí¨ Tin nh·∫Øn</h2>
					<div class="user-info">
						Logged in as: <strong id="currentUserName">User</strong>
					</div>
				</div>
				<div class="user-list" id="userList">
					<div style="padding: 20px; text-align: center; color: #999">
						ƒêang t·∫£i danh s√°ch...
					</div>
				</div>
			</div>

			<div class="chat-area">
				<div id="statusBar" class="status-indicator">‚úÖ ƒê√£ k·∫øt n·ªëi</div>

				<div class="chat-header">
					<div class="user-avatar" id="chatAvatar">?</div>
					<div style="flex: 1">
						<h3 id="chatUserName">Ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat</h3>
						<div
							id="typingIndicator"
							class="typing-indicator"
							style="display: none">
							ƒëang g√µ...
						</div>
					</div>
				</div>

				<div class="messages" id="messages">
					<div style="text-align: center; padding: 50px; color: #999">
						Ch·ªçn m·ªôt ng∆∞·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu chat
					</div>
				</div>

				<div class="message-input-area">
					<input
						type="text"
						id="messageInput"
						class="message-input"
						placeholder="Nh·∫≠p tin nh·∫Øn..."
						disabled />
					<button
						onclick="sendMessage()"
						class="send-button"
						id="sendButton"
						disabled>
						G·ª≠i
					</button>
				</div>
			</div>
		</div>

		<script>
			let socket = null;
			let currentUserId = null;
			let currentChatUserId = null;
			let typingTimeout = null;

			function connect() {
				const token = document
					.getElementById('tokenInput')
					.value.trim();

				if (!token) {
					alert('Vui l√≤ng nh·∫≠p JWT token');
					return;
				}

				// Decode JWT ƒë·ªÉ l·∫•y user info (kh√¥ng verify, ch·ªâ decode)
				try {
					const payload = JSON.parse(atob(token.split('.')[1]));
					// Token c·ªßa backend c√≥ field 'id' kh√¥ng ph·∫£i 'userId'
					currentUserId = payload.id;
					document.getElementById('currentUserName').textContent =
						'User ' + currentUserId;
				} catch (e) {
					alert('Token kh√¥ng h·ª£p l·ªá');
					return;
				}

				// K·∫øt n·ªëi socket
				socket = io('http://localhost:3000', {
					auth: { token },
				});

				socket.on('connect', () => {
					console.log('Connected to server');
					document.getElementById('loginScreen').style.display =
						'none';
					document.getElementById('chatContainer').style.display =
						'flex';
					updateStatus(true);
					loadChatUsers();
				});

				socket.on('disconnect', () => {
					console.log('Disconnected from server');
					updateStatus(false);
				});

				socket.on('connect_error', (error) => {
					alert('K·∫øt n·ªëi th·∫•t b·∫°i: ' + error.message);
					console.error('Connection error:', error);
				});

				socket.on('chat:message', (message) => {
					console.log('New message:', message);
					if (
						currentChatUserId &&
						(message.sender_id === currentChatUserId ||
							message.receiver_id === currentChatUserId)
					) {
						displayMessage(message);

						// ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc n·∫øu ƒëang chat v·ªõi ng∆∞·ªùi n√†y
						if (message.sender_id === currentChatUserId) {
							markAsRead(currentChatUserId);
						}
					}
					loadChatUsers(); // Refresh user list
				});

				socket.on('chat:typing', (data) => {
					if (data.userId === currentChatUserId) {
						showTyping(data.isTyping);
					}
				});

				socket.on('user:online', (data) => {
					console.log('User online:', data);
					updateUserOnlineStatus(data.userId, true);
				});

				socket.on('user:offline', (data) => {
					console.log('User offline:', data);
					updateUserOnlineStatus(data.userId, false);
				});
			}

			function updateStatus(connected) {
				const statusBar = document.getElementById('statusBar');
				if (connected) {
					statusBar.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi';
					statusBar.className = 'status-indicator';
				} else {
					statusBar.textContent = '‚ùå M·∫•t k·∫øt n·ªëi';
					statusBar.className = 'status-indicator disconnected';
				}
			}

			function loadChatUsers() {
				socket.emit('chat:users', (response) => {
					if (response.success) {
						displayUserList(response.data);
					} else {
						console.error('Error loading users:', response.error);
					}
				});
			}

			function displayUserList(users) {
				const userList = document.getElementById('userList');
				userList.innerHTML = '';

				if (users.length === 0) {
					userList.innerHTML =
						'<div style="padding: 20px; text-align: center; color: #999;">Ch∆∞a c√≥ tin nh·∫Øn n√†o</div>';
					return;
				}

				users.forEach((user) => {
					const div = document.createElement('div');
					div.className = 'user-item';
					if (currentChatUserId === user.id) {
						div.classList.add('active');
					}
					div.onclick = () => selectUser(user);

					const initials = user.full_name
						.split(' ')
						.map((n) => n[0])
						.join('')
						.substring(0, 2)
						.toUpperCase();

					div.innerHTML = `
                    <div class="user-avatar">${initials}</div>
                    <div class="user-details">
                        <div class="user-name">${user.full_name}</div>
                        <div class="user-last-message">${
							user.last_message || 'B·∫Øt ƒë·∫ßu chat'
						}</div>
                    </div>
                    ${
						user.is_online
							? '<div class="online-indicator"></div>'
							: ''
					}
                    ${
						user.unread_count > 0
							? `<div class="unread-badge">${user.unread_count}</div>`
							: ''
					}
                `;

					userList.appendChild(div);
				});
			}

			function selectUser(user) {
				currentChatUserId = user.id;

				const initials = user.full_name
					.split(' ')
					.map((n) => n[0])
					.join('')
					.substring(0, 2)
					.toUpperCase();
				document.getElementById('chatAvatar').textContent = initials;
				document.getElementById('chatUserName').textContent =
					user.full_name;
				document.getElementById('messageInput').disabled = false;
				document.getElementById('sendButton').disabled = false;

				// Load chat history
				socket.emit(
					'chat:history',
					{
						otherUserId: user.id,
						limit: 50,
						offset: 0,
					},
					(response) => {
						if (response.success) {
							displayMessages(response.data);
							markAsRead(user.id);
						}
					},
				);

				// Update active state in user list
				document.querySelectorAll('.user-item').forEach((item) => {
					item.classList.remove('active');
				});
				event.target.closest('.user-item').classList.add('active');
			}

			function displayMessages(messages) {
				const messagesDiv = document.getElementById('messages');
				messagesDiv.innerHTML = '';

				messages.forEach((msg) => {
					displayMessage(msg);
				});

				scrollToBottom();
			}

			function displayMessage(message) {
				const messagesDiv = document.getElementById('messages');
				const div = document.createElement('div');
				div.className = 'message';

				if (message.sender_id === currentUserId) {
					div.classList.add('own');
				}

				const time = new Date(message.created_at).toLocaleTimeString(
					'vi-VN',
					{
						hour: '2-digit',
						minute: '2-digit',
					},
				);

				const initials = message.sender_name
					? message.sender_name
							.split(' ')
							.map((n) => n[0])
							.join('')
							.substring(0, 2)
							.toUpperCase()
					: '?';

				div.innerHTML = `
                <div class="message-avatar">${initials}</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(
						message.message,
					)}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

				messagesDiv.appendChild(div);
				scrollToBottom();
			}

			function sendMessage() {
				const input = document.getElementById('messageInput');
				const message = input.value.trim();

				if (!message || !currentChatUserId) return;

				socket.emit(
					'chat:send',
					{
						receiverId: currentChatUserId,
						message: message,
					},
					(response) => {
						if (response.success) {
							displayMessage(response.data);
							input.value = '';
							loadChatUsers(); // Refresh user list
						} else {
							alert('G·ª≠i tin nh·∫Øn th·∫•t b·∫°i: ' + response.error);
						}
					},
				);
			}

			function markAsRead(senderId) {
				socket.emit('chat:read', { senderId });
			}

			function showTyping(isTyping) {
				const indicator = document.getElementById('typingIndicator');
				indicator.style.display = isTyping ? 'block' : 'none';
			}

			function updateUserOnlineStatus(userId, isOnline) {
				// Update in user list
				loadChatUsers();
			}

			function scrollToBottom() {
				const messagesDiv = document.getElementById('messages');
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}

			function escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			// Handle Enter key
			document.addEventListener('DOMContentLoaded', () => {
				document
					.getElementById('messageInput')
					.addEventListener('keypress', (e) => {
						if (e.key === 'Enter') {
							sendMessage();
						}

						// Typing indicator
						if (currentChatUserId) {
							socket.emit('chat:typing', {
								receiverId: currentChatUserId,
								isTyping: true,
							});

							clearTimeout(typingTimeout);
							typingTimeout = setTimeout(() => {
								socket.emit('chat:typing', {
									receiverId: currentChatUserId,
									isTyping: false,
								});
							}, 1000);
						}
					});
			});
		</script>
	</body>
</html>
