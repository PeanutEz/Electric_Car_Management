# üîî PayOS Webhook Guide

## üìã T·ªïng quan

API webhook t·ª± ƒë·ªông x·ª≠ l√Ω th√¥ng b√°o t·ª´ PayOS khi c√≥ thay ƒë·ªïi tr·∫°ng th√°i thanh to√°n. Khi payment status l√† **PAID**, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông:

1. ‚úÖ C·∫≠p nh·∫≠t order status t·ª´ PENDING ‚Üí PAID
2. üí∞ C·ªông ti·ªÅn v√†o `total_credit` c·ªßa user
3. üìä C·ªông quota n·∫øu l√† service (post/push/verify)

---

## üîó Endpoint

```
POST /api/payment/payos-webhook
```

**‚ö†Ô∏è L∆∞u √Ω:** Endpoint n√†y **KH√îNG** c·∫ßn authentication v√¨ ƒë∆∞·ª£c g·ªçi t·ª± ƒë·ªông t·ª´ PayOS server.

---

## üì• Webhook Data Structure

PayOS s·∫Ω g·ª≠i POST request v·ªõi body theo format chu·∫©n:

```json
{
	"data": {
		"orderCode": 123456789,
		"status": "PAID",
		"amount": 50000,
		"description": "Thanh to√°n ƒë∆°n h√†ng #123456789",
		"transactionDateTime": "2025-10-13T10:35:00Z"
	},
	"signature": "abcxyz123checksum"
}
```

### Required Fields:

-   `data.orderCode` (number): M√£ ƒë∆°n h√†ng t·ª´ h·ªá th·ªëng c·ªßa b·∫°n
-   `data.status` (string): Tr·∫°ng th√°i thanh to√°n (PAID, CANCELLED, PENDING)
-   `data.amount` (number): S·ªë ti·ªÅn thanh to√°n

### Optional Fields:

-   `data.description` (string): M√¥ t·∫£ giao d·ªãch
-   `data.transactionDateTime` (string): Th·ªùi gian giao d·ªãch (ISO 8601)
-   `signature` (string): Ch·ªØ k√Ω HMAC SHA256 ƒë·ªÉ x√°c th·ª±c webhook

### Status Values:

-   `PAID`: Thanh to√°n th√†nh c√¥ng
-   `CANCELLED`: Thanh to√°n b·ªã h·ªßy
-   `PENDING`: ƒêang ch·ªù thanh to√°n

### Example Payloads:

**1. Full Format (Recommended):**

```json
{
	"data": {
		"orderCode": 741765,
		"status": "PAID",
		"amount": 50000,
		"description": "Thanh to√°n ƒë∆°n h√†ng #741765",
		"transactionDateTime": "2025-10-13T10:35:00Z"
	},
	"signature": "abc123xyz456"
}
```

**2. Minimum Required:**

```json
{
	"data": {
		"orderCode": 152502,
		"status": "PAID",
		"amount": 3000
	}
}
```

**3. With Signature in Header (Alternative):**

```
Headers:
  x-payos-signature: abc123xyz456

Body:
{
  "data": {
    "orderCode": 741765,
    "status": "PAID",
    "amount": 50000
  }
}
```

---

## ‚öôÔ∏è C·∫•u h√¨nh PayOS Webhook

### B∆∞·ªõc 1: ƒêƒÉng nh·∫≠p PayOS Dashboard

1. Truy c·∫≠p: https://payos.vn/
2. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n merchant

### B∆∞·ªõc 2: C·∫•u h√¨nh Webhook URL

1. V√†o m·ª•c **Settings** ‚Üí **Webhooks**
2. Th√™m Webhook URL:
    - **Development:** `https://your-ngrok-url.ngrok.io/api/payment/payos-webhook`
    - **Production:** `https://your-domain.com/api/payment/payos-webhook`

### B∆∞·ªõc 3: Ch·ªçn Events

Ch·ªçn c√°c events mu·ªën nh·∫≠n:

-   ‚úÖ `payment.success` (PAID)
-   ‚úÖ `payment.cancelled` (CANCELLED)

### B∆∞·ªõc 4: Test Webhook (Development)

N·∫øu ƒëang develop local, c·∫ßn s·ª≠ d·ª•ng **ngrok** ƒë·ªÉ expose local server:

```bash
# C√†i ƒë·∫∑t ngrok (n·∫øu ch∆∞a c√≥)
npm install -g ngrok

# Ch·∫°y server local
npm run dev  # Server ch·∫°y tr√™n port 3000

# M·ªü terminal m·ªõi, expose port 3000
ngrok http 3000
```

Ngrok s·∫Ω t·∫°o public URL: `https://abc123.ngrok.io`

Copy URL n√†y v√† th√™m v√†o PayOS Dashboard:

```
https://abc123.ngrok.io/api/payment/payos-webhook
```

---

## üîÑ Flow x·ª≠ l√Ω

### Scenario 1: Payment Success (PAID)

```
1. User t·∫°o order ‚Üí status = PENDING
2. User thanh to√°n qua PayOS
3. PayOS g·ª≠i webhook ‚Üí /api/payment/payos-webhook
4. Server ki·ªÉm tra:
   ‚úÖ Order t·ªìn t·∫°i?
   ‚úÖ Status = PAID?
   ‚úÖ Order ch∆∞a ƒë∆∞·ª£c x·ª≠ l√Ω? (status != PAID)
5. Server c·∫≠p nh·∫≠t:
   üìù orders.status = PAID
   üí∞ users.total_credit += order.price
   üìä user_quota.amount += service.number_of_post (n·∫øu c√≥)
6. Response 200 OK
```

### Scenario 2: Payment Cancelled

```
1. User h·ªßy thanh to√°n
2. PayOS g·ª≠i webhook v·ªõi status = CANCELLED
3. Server c·∫≠p nh·∫≠t:
   üìù orders.status = CANCELLED
4. Response 200 OK
```

---

## üìä Database Changes

### B·∫£ng `orders`

```sql
-- Tr∆∞·ªõc webhook
| code   | status  | price  | buyer_id |
|--------|---------|--------|----------|
| 741765 | PENDING | 50000  | 1        |

-- Sau webhook (PAID)
| code   | status | price  | buyer_id | updated_at          |
|--------|--------|--------|----------|---------------------|
| 741765 | PAID   | 50000  | 1        | 2025-10-13 10:30:00 |
```

### B·∫£ng `users`

```sql
-- Tr∆∞·ªõc webhook
| id | total_credit |
|----|--------------|
| 1  | 100000       |

-- Sau webhook
| id | total_credit |
|----|--------------|
| 1  | 150000       | -- +50000
```

### B·∫£ng `user_quota` (n·∫øu l√† service post/push/verify)

```sql
-- Tr∆∞·ªõc webhook
| user_id | service_id | amount |
|---------|------------|--------|
| 1       | 1          | 0      |

-- Sau webhook (service c√≥ number_of_post = 3)
| user_id | service_id | amount |
|---------|------------|--------|
| 1       | 1          | 3      | -- +3
```

---

## üß™ Testing Webhook

### Test v·ªõi cURL

**Test Case 1: Payment Success (Full Format)**

```bash
curl -X POST http://localhost:3000/api/payment/payos-webhook \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "orderCode": 741765,
      "status": "PAID",
      "amount": 50000,
      "description": "Thanh to√°n ƒë∆°n h√†ng #741765",
      "transactionDateTime": "2025-10-13T10:35:00Z"
    },
    "signature": "abcxyz123checksum"
  }'
```

**Test Case 2: Minimum Required Fields**

```bash
curl -X POST http://localhost:3000/api/payment/payos-webhook \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "orderCode": 152502,
      "status": "PAID",
      "amount": 3000
    }
  }'
```

**Test Case 3: Payment Cancelled**

```bash
curl -X POST http://localhost:3000/api/payment/payos-webhook \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "orderCode": 774448,
      "status": "CANCELLED",
      "amount": 3000
    }
  }'
```

### Test v·ªõi Postman

1. **Method:** POST
2. **URL:** `http://localhost:3000/api/payment/payos-webhook`
3. **Headers:**
    ```
    Content-Type: application/json
    ```
4. **Body (raw JSON):**
    ```json
    {
    	"data": {
    		"orderCode": 741765,
    		"status": "PAID",
    		"amount": 50000,
    		"description": "Thanh to√°n ƒë∆°n h√†ng #741765",
    		"transactionDateTime": "2025-10-13T10:35:00Z"
    	},
    	"signature": "abcxyz123checksum"
    }
    ```

### Test v·ªõi PowerShell (Windows)

```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/payment/payos-webhook" `
  -Method POST `
  -ContentType "application/json" `
  -Body '{
    "data": {
      "orderCode": 741765,
      "status": "PAID",
      "amount": 50000,
      "description": "Thanh to√°n ƒë∆°n h√†ng #741765",
      "transactionDateTime": "2025-10-13T10:35:00Z"
    },
    "signature": "abcxyz123checksum"
  }'
```

### Expected Response (Success)

```json
{
	"success": true,
	"message": "Payment processed successfully",
	"data": {
		"success": true,
		"message": "Payment processed successfully",
		"orderCode": 741765,
		"userId": 1,
		"amountAdded": 50000
	}
}
```

### Expected Response (Already Processed)

```json
{
	"success": false,
	"message": "Order already processed or invalid status. Current: PAID, Webhook: PAID",
	"data": {
		"success": false,
		"message": "Order already processed...",
		"orderCode": 741765
	}
}
```

---

## üîç Debugging

### Check Server Logs

```bash
# Server s·∫Ω log m·ªçi webhook nh·∫≠n ƒë∆∞·ª£c
üì• PayOS Webhook received: { data: { orderCode: 741765, status: 'PAID' } }
‚úÖ Payment processed successfully for order 741765
```

### Check Database

```sql
-- Ki·ªÉm tra order status
SELECT code, status, price, buyer_id, created_at, updated_at
FROM orders
WHERE code = 741765;

-- Ki·ªÉm tra user credit
SELECT id, full_name, total_credit
FROM users
WHERE id = 1;

-- Ki·ªÉm tra quota (n·∫øu c√≥)
SELECT user_id, service_id, amount
FROM user_quota
WHERE user_id = 1;
```

### Common Issues

| Issue                   | Cause                        | Solution                                        |
| ----------------------- | ---------------------------- | ----------------------------------------------- |
| Webhook kh√¥ng ƒë∆∞·ª£c g·ªçi  | Ngrok ch∆∞a ch·∫°y ho·∫∑c URL sai | Ki·ªÉm tra ngrok running, copy ƒë√∫ng URL           |
| Invalid webhook format  | Thi·∫øu field `data`           | ƒê·∫£m b·∫£o payload c√≥ structure: `{"data": {...}}` |
| Order not found         | OrderCode kh√¥ng t·ªìn t·∫°i      | Ki·ªÉm tra l·∫°i orderCode trong database           |
| Duplicate processing    | Webhook ƒë∆∞·ª£c g·ªçi nhi·ªÅu l·∫ßn   | H·ªá th·ªëng ƒë√£ x·ª≠ l√Ω, check `status != PAID`       |
| User credit kh√¥ng tƒÉng  | Order status ƒë√£ l√† PAID      | Ch·ªâ x·ª≠ l√Ω khi order PENDING ‚Üí PAID              |
| Invalid signature (401) | Signature kh√¥ng kh·ªõp         | Ki·ªÉm tra PAYOS_CHECKSUM_KEY trong .env          |

---

## üîê Security Notes

### Environment Variables

Th√™m v√†o file `.env`:

```env
# PayOS Configuration
PAYOS_CLIENT_ID=your_client_id
PAYOS_API_KEY=your_api_key
PAYOS_CHECKSUM_KEY=your_checksum_key

# Application URLs
CLIENT_URL=http://localhost:4000
```

### Webhook Signature Verification

API ƒë√£ t√≠ch h·ª£p signature verification:

**How it works:**

1. PayOS g·ª≠i webhook v·ªõi `signature` field ho·∫∑c `x-payos-signature` header
2. Server t√≠nh to√°n HMAC SHA256 t·ª´ `data` object
3. So s√°nh signature nh·∫≠n ƒë∆∞·ª£c v·ªõi signature t√≠nh to√°n
4. Ch·ªâ x·ª≠ l√Ω n·∫øu signature h·ª£p l·ªá

**Implementation:**

```typescript
const verifyPayOSSignature = (webhookData: any, signature: string): boolean => {
	const secretKey = process.env.PAYOS_CHECKSUM_KEY;
	const dataString = JSON.stringify(webhookData.data);
	const hash = crypto
		.createHmac('sha256', secretKey)
		.update(dataString)
		.digest('hex');

	return hash === signature;
};
```

**‚ö†Ô∏è Development Mode:**

-   N·∫øu kh√¥ng c√≥ `PAYOS_CHECKSUM_KEY`, signature verification b·ªã skip
-   Production ph·∫£i enable signature verification

### Payload Validation

API validate c√°c fields b·∫Øt bu·ªôc:

-   ‚úÖ `data` object must exist
-   ‚úÖ `data.orderCode` must exist
-   ‚úÖ `data.status` must exist
-   ‚úÖ `signature` (optional but recommended)

**Validation Flow:**

```typescript
if (!webhookData.data) {
  return 400 Bad Request - "Invalid webhook format"
}

if (!orderCode || !status) {
  return 400 Bad Request - "Missing required fields"
}

if (signature && PAYOS_CHECKSUM_KEY) {
  if (!verifyPayOSSignature()) {
    return 401 Unauthorized - "Invalid signature"
  }
}
```

    ---

## üìö Related Files

-   **Service:** `src/services/service.service.ts` ‚Üí `handlePayOSWebhook()`
-   **Controller:** `src/controllers/payment.controller.ts` ‚Üí `payosWebhookHandler()` + `verifyPayOSSignature()`
-   **Route:** `src/routes/payment.route.ts` ‚Üí `POST /payos-webhook`
-   **Test Script:** `test-webhook.sh` ‚Üí cURL commands
-   **Documentation:** `PAYOS_WEBHOOK_GUIDE.md` ‚Üí This file

---

## üéØ Summary

### Webhook Behavior

‚úÖ **Valid Request:**

```json
{
	"data": {
		"orderCode": 123456,
		"status": "PAID",
		"amount": 50000
	},
	"signature": "abc123"
}
```

‚Üí Response: 200 OK + Credit updated

‚ùå **Invalid Format:**

```json
{
	"orderCode": 123456,
	"status": "PAID"
}
```

‚Üí Response: 400 Bad Request

‚ùå **Invalid Signature:**

```json
{
  "data": {...},
  "signature": "wrong_signature"
}
```

‚Üí Response: 401 Unauthorized

‚úÖ **Already Processed:**

```json
{
	"data": {
		"orderCode": 123456, // Already PAID
		"status": "PAID"
	}
}
```

‚Üí Response: 200 OK (but no database changes)

### Processing Flow

```
PayOS ‚Üí POST /api/payment/payos-webhook
        ‚Üì
    Validate structure (data field exists?)
        ‚Üì
    Validate required fields (orderCode, status?)
        ‚Üì
    Verify signature (if provided)
        ‚Üì
    Check order exists in database
        ‚Üì
    Check order not already processed
        ‚Üì
    START TRANSACTION
        ‚Üì
    Update order status ‚Üí PAID
        ‚Üì
    Add credit to user
        ‚Üì
    Add quota (if service)
        ‚Üì
    COMMIT TRANSACTION
        ‚Üì
    Response 200 OK
```

---

## ‚úÖ Checklist

-   [ ] ƒê√£ c·∫•u h√¨nh Webhook URL trong PayOS Dashboard
-   [ ] ƒê√£ test webhook v·ªõi ngrok (development)
-   [ ] ƒê√£ verify webhook ƒë∆∞·ª£c g·ªçi (check logs)
-   [ ] ƒê√£ verify database ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng
-   [ ] ƒê√£ th√™m signature verification (production)
-   [ ] ƒê√£ deploy production URL v√† update PayOS Dashboard

---

## üöÄ Production Deployment

Khi deploy l√™n production:

1. Update PayOS Webhook URL:

    ```
    https://api.yourcompany.com/api/payment/payos-webhook
    ```

2. ƒê·∫£m b·∫£o server c√≥ th·ªÉ nh·∫≠n POST request t·ª´ PayOS IPs

3. Enable signature verification

4. Monitor webhook logs v√† database changes

5. Setup alert n·∫øu webhook fail
